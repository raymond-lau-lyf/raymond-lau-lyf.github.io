<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>notes of FEJ |  Yufeng Liu</title>
    <meta name="author" content=" Yufeng Liu">
    <meta name="description" content="notes of First-Estimate Jacobian">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/like_emoji.png">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://raymond-lau-lyf.github.io/blog/2023/math/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/">Yufeng Liu</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">notes of FEJ</h1>
    <p class="post-meta">July 18, 2023</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>
        ·  
        <a href="/blog/tag/math">
          <i class="fas fa-hashtag fa-sm"></i> math</a>  
          
        ·  
        <a href="/blog/category/sample-posts">
          <i class="fas fa-tag fa-sm"></i> sample-posts</a>  
          

    </p>
  </header>

  <article class="post-content">
    
    <div id="markdown-content">
      <h3 id="reference--httpsdocsopenvinscomfejhtml">Reference : https://docs.openvins.com/fej.html</h3>
<h3 id="self-use-note-自用笔记">self-use-note 自用笔记</h3>

<h2 id="background">background</h2>

<p>在VINS中 关注 <strong>observability</strong> (能观性) 和  <strong>consistency</strong> (一致性)
可以作为研究系统退化的切入点</p>

<p><code class="language-plaintext highlighter-rouge">Naive EKF-based VINS estimators have been shown to be inconsistent due to spurious information gain along unobservable directions and have required the creation of "observability aware" filters which explicitly address the inaccurate information gains causing filter over-confidence (the estimated uncertainty is smaller than the true)</code></p>

<p><code class="language-plaintext highlighter-rouge">由于沿不可观测方向存在虚假的信息增益，基于 EKF 的非直接 VINS 估计器已被证明是不一致的，因此需要创建 "可观测性感知 "滤波器，以明确解决造成滤波器过度置信（估计的不确定性小于真实的不确定性）的不准确信息增益问题。</code></p>

<p>一致性是滤波优化的必要条件,错误的协方差会产生错误的增益。</p>

<p><strong>First-estimates Jacobian (FEJ)</strong> 方法被提出，用于:</p>
<ul>
  <li>保证VINS的<strong>observability</strong>
</li>
  <li>提升<strong>consistency</strong>
</li>
</ul>

<h2 id="ekf-linearized-error-state-system">EKF Linearized Error-State System</h2>

<p>openvins用到的经典的pvq模型:</p>

\[\begin{align*} \mathbf{x}_k &amp;= \begin{bmatrix} {}_G^{I_{k}} \bar{q}{}^{\top} &amp; {}^G\mathbf{p}_{I_k}^{\top} &amp; {}^G\mathbf{v}_{I_k}^{\top} &amp; {}^G\mathbf{p}_{f}^{\top} \end{bmatrix}^{\top} \end{align*}\]

<p>经典的 error-state update:</p>

\[\begin{align*} \tilde{\mathbf{x}}_{k|k-1} &amp;= \mathbf{\Phi}_{(k,k-1)}~\tilde{\mathbf{x}}_{k-1|k-1} + \mathbf{G}_{k}\mathbf{w}_{k} \\ \tilde{\mathbf{z}}_{k} &amp;= \mathbf{H}_{k}~\tilde{\mathbf{x}}_{k|k-1}+\mathbf{n}_{k} \end{align*}\]

<p>状态转移矩阵 \({\Phi}_{(k,k-1)}\):</p>

\[\begin{align*} \mathbf{\Phi}_{(k,k-1)}&amp;= 
\begin{bmatrix} 
{}^{I_{k}}_{I_{k-1}}\mathbf R &amp; \mathbf 0_{3\times3} &amp; \mathbf 0_{3\times3} &amp; \mathbf 0_{3\times3} \\[1em] 
 -{}^{I_{k-1}}_{G}\mathbf{R}^\top \lfloor \boldsymbol\alpha(k,k-1) \times\rfloor &amp; \mathbf I_{3\times3} &amp; (t_{k}-t_{k-1})\mathbf I_{3\times3} &amp; \mathbf 0_{3\times3} \\[1em] 
 -{}^{I_{k-1}}_{G}\mathbf{R}^\top \lfloor \boldsymbol\beta(k,k-1) \times\rfloor &amp; \mathbf 0_{3\times3} &amp; \mathbf I_{3\times3} &amp; \mathbf 0_{3\times3} \\[1em]
 \mathbf 0_{3\times3} &amp; \mathbf 0_{3\times3} &amp; \mathbf 0{3\times3} &amp; \mathbf I_{3\times3} \end{bmatrix} 
\end{align*}\]

\[\begin{align*}
\boldsymbol\alpha(k,k-1) &amp;= \int_{t_{k-1}}^{k} \int_{t_{k-1}}^{s} {}^{I_{k-1}}_{\tau}\mathbf R (\mathbf a(\tau)-\mathbf b_a - \mathbf w_a) d\tau ds \\ 
\boldsymbol\beta(k,k-1) &amp;= \int_{t_{k-1}}^{t_k} {}^{I_{k-1}}_{\tau}\mathbf R (\mathbf a(\tau)-\mathbf b_a - \mathbf w_a) d\tau 
\end{align*}\]

<p>测量雅各比(measurement Jacobian Matrix) \({H}_{k}\):</p>

\[\begin{align*} \mathbf{H}_{k} &amp;= \mathbf H_{proj,k}~\mathbf H_{state,k} \\ &amp;= \begin{bmatrix} \frac{1}{Iz} &amp; 0 &amp; \frac{-{}^Ix}{({}^Iz)^2} \\ 0 &amp; \frac{1}{Iz} &amp; \frac{-{}^Iy}{({}^Iz)^2} \\ \end{bmatrix} \begin{bmatrix} \lfloor {}^{I_k}_{G}\mathbf{R}({}^{G}\mathbf{p}_f-{}^{G}\mathbf{p}_{I_k}) \times\rfloor &amp; -{}^{I_k}_{G}\mathbf{R} &amp; \mathbf 0_{3\times3} &amp; {}^{I_k}_{G}\mathbf{R} \end{bmatrix} \\
&amp;= \mathbf H_{proj,k}~ 
{}^{I_k}_{G}\mathbf{R} 
\begin{bmatrix} 
\lfloor ({}^{G}\mathbf{p}_f-{}^{G}\mathbf{p}_{I_k}) \times\rfloor 
{}^{I_k}_{G}\mathbf{R}^\top &amp; 
-\mathbf I_{3\times3} &amp; 
\mathbf 0_{3\times3} &amp; 
\mathbf I_{3\times3} 
\end{bmatrix} 
\end{align*}\]

<h2 id="linearized-system-observability">Linearized System Observability</h2>

<p>能观性矩阵 \(\mathcal{O}\): 若 \(\mathcal{O}\) 列满秩，则完全能观。它的零空间则描述了无法用给定测量恢复的不可观状态子空间</p>

\[\begin{align*} \mathcal{O}= \begin{bmatrix} \mathbf{H}_{0}\mathbf{\Phi}_{(0,0)} \\ \mathbf{H}_{1}\mathbf{\Phi}_{(1,0)} \\ \mathbf{H}_{2}\mathbf{\Phi}_{(2,0)} \\ \vdots \\ \mathbf{H}_{k}\mathbf{\Phi}_{(k,0)} \\ \end{bmatrix} \end{align*}\]

<p>他的零空间 \(\mathcal{N}\) 为4dof，对应于YAW和global xyz translation:</p>

\[\begin{align*} \mathcal{N} &amp;= \begin{bmatrix} {}^{I_{0}}_{G}\mathbf{R}{}^G\mathbf{g} &amp; \mathbf 0_{3\times3} \\ -\lfloor {}^{G}\mathbf{p}_{I_0} \times\rfloor{}^G\mathbf{g} &amp; \mathbf{I}_{3\times3} \\ -\lfloor {}^{G}\mathbf{v}_{I_0} \times\rfloor{}^G\mathbf{g} &amp; \mathbf{0}_{3\times3} \\ -\lfloor {}^{G}\mathbf{p}_{f} \times\rfloor{}^G\mathbf{g} &amp; \mathbf{I}_{3\times3} \\ \end{bmatrix} \end{align*}\]

<h2 id="first-estimate-jacobians">First Estimate Jacobians</h2>

<p><code class="language-plaintext highlighter-rouge">It has been showed that standard EKF based-VINS, which always computes the state translation matrix and the measurement Jacobian using the current state estimates, has the global yaw orientation appear to be observable and has an incorrectly reduced 3dof nullspace dimention. This causes the filter mistakenly gaining extra information and becoming overconfident in the yaw.</code></p>

<p><code class="language-plaintext highlighter-rouge">To solve this issue, the First-Estimate Jacobains (FEJ)methodology can be applied. It evaluates the linearized system state transition matrix and Jacobians at the same estimate (i.e., the first estimates) over all time periods and thus ensures that the 4dof unobservable VINS subspace does not gain spurious information. The application of FEJ is simple yet effective, let us consider how to modify the propagation and update linearizations.</code></p>

<p><code class="language-plaintext highlighter-rouge">已经表明，基于标准 EKF 的 VINS 始终使用</code><strong><code class="language-plaintext highlighter-rouge">当前状态估计</code></strong><code class="language-plaintext highlighter-rouge">来计算状态转换矩阵和测量雅可比行列式，其全局偏航方向似乎是可观察的，并且具有错误减少的 3dof 零空间维度。 这会导致滤波器错误地获取额外信息并对偏航变得过于自信。</code></p>

<p><code class="language-plaintext highlighter-rouge">为了解决这个问题，可以应用FEJ方法。 它在所有时间段内以相同的估计（即第一次估计）评估线性化系统状态转移矩阵和雅可比行列式，从而确保 4dof 不可观测的 VINS 子空间不会获得虚假信息。 FEJ 的应用简单而有效，让我们考虑如何修改传播和更新线性化。</code></p>

<h3 id="propagation">Propagation</h3>
<p>Guoquan Huang老师提出更加正确的状态转移矩阵更新方式，表明:
不是</p>

\[\begin{align*} \mathbf{\Phi}_{(k+1,k-1)}(\mathbf{x}_{k+1|k},\mathbf{x}_{k-1|k-1}) \neq \mathbf{\Phi}_{(k+1,k)}(\mathbf{x}_{k+1|k},\mathbf{x}_{k|k}) ~ \mathbf{\Phi}_{(k,k-1)}(\mathbf{x}_{k|k-1},\mathbf{x}_{k-1|k-1}) \end{align*}\]

<p>而是</p>

\[\begin{align*} \mathbf{\Phi}_{(k+1,k-1)}(\mathbf{x}_{k+1|k},\mathbf{x}_{k-1|k-1}) = \mathbf{\Phi}_{(k+1,k)}(\mathbf{x}_{k+1|k},\mathbf{x}_{k|k-1}) ~ \mathbf{\Phi}_{(k,k-1)}(\mathbf{x}_{k|k-1},\mathbf{x}_{k-1|k-1}) \end{align*}\]

<p>区别就是在于不同的时间节点线性化评估</p>

<h3 id="update">Update</h3>

<p>指出了一般情况下，nullspace的第一列都是无效的： For example, the feature estimate in each row of  are different, thus the nullsace does not hold.</p>

<p>使得能观性矩阵的维数退化成3</p>

<p>需要选择first state estimate</p>

<p>就得到了想要的线性化测量更新函数(linearized measurement update function):</p>

\[\begin{align*} \tilde{\mathbf{z}}_{k+1} = \mathbf{z}_{k+1} - \mathbf{h}(\hat{\mathbf{x}}_k) \simeq \bar{\mathbf{H}}_{k} (\mathbf{x}_{k} -\hat{\mathbf{x}}_k ) + \mathbf{n}_k \end{align*}\]

<p>\(\bar{\mathbf{H}}_{k}\)
是第一估计雅可比行列式，仅包含第一状态估计
\(\bar{\mathbf{x}_{k}}\)</p>

<p>使用FEJ可以保留系统的能观性</p>

<p>虽然这样做会引入线性化误差，但是Guoquan Huang老师等人认为inconsistencies对系统的副作用还是更大。FEJ2[Chuchu Chen, Yulin Yang, Patrick Geneva, and Guoquan Huang. Fej2: A consistent visual-inertial state estimator design. In 2022 International Conference on Robotics and Automation (ICRA), 2022.],OC[Guoquan P Huang, Anastasios I Mourikis, and Stergios I Roumeliotis. Observability-based rules for designing consistent ekf slam estimators. The International Journal of Robotics Research, 29(5):502–528, 2010.]等工作也在试图解决这个问题,在补偿或利用最佳估计的同时，解决确保正确可观测性的问题。</p>

<p><code class="language-plaintext highlighter-rouge">具体来说，位姿采用propagated值而非updated值，landmark使用第一次估计值。First Estimate就是这个直观含义，即采用estimation from the first time。</code></p>

<p>—- 如何理解SLAM中的First-Estimates Jacobian？ - jing胖的回答 - 知乎
https://www.zhihu.com/question/52869487/answer/132517493</p>

<h2 id="comments-注释">comments 注释</h2>


    </div>
  </article>
</div>

      
    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2024  Yufeng Liu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>

  <!-- Bootstrap Table -->
  <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>

  <!-- Load Common JS -->
  <script src="/assets/js/no_defer.js"></script>
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
